<!-- Includes JQuery from CDN -->
<script
        src="http://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
        crossorigin="anonymous">
</script>
<script>
  var dotterTimer;
  var dotCount = 0;
  var dragFile;

  function enableUpload()
  {
    var x = document.getElementById("file");

    if (x.value !== "")
    {
      document.getElementById("uploadButton").disabled = false;
    }
    else
    {
      document.getElementById("uploadButton").disabled = true;
    }
  }

  function uploadToJarvis(endpoint)
  {
    window.clearTimeout(dotterTimer);
    dotCount = 0;
    document.getElementById("output").innerHTML = "Uploading...";

    var xhttp = new XMLHttpRequest();

    var formData = new FormData();

    if (document.getElementById('runMoss') != undefined)
    {
      formData.append('runMoss', document.getElementById('runMoss').checked);
    }

    if (document.getElementById('runCode') != undefined)
    {
      formData.append('runCode', document.getElementById('runCode').checked);
    }

    if (document.getElementById('file').files[0] != undefined)
    {
      formData.append('file', document.getElementById('file').files[0], "thefile");
    }
    else if (dragFile !== undefined)
    {
      formData.append('file', dragFile, "thefile");
    }
    else
    {
      alert('ooops, no file was selected');
    }

    xhttp.onreadystatechange = function()
    {
      if (xhttp.readyState === 4 && xhttp.status === 200)
      {
        window.clearTimeout(dotterTimer);
        document.getElementById("output").innerHTML = xhttp.responseText;
        $('.header').click(function(){
          console.log('clicked');
          $(this).toggleClass('expand').nextUntil('tr.header').slideToggle(100);
        });
        $('.header').toggleClass('expand').nextUntil('tr.header').slideToggle(100);
      }
      else if (xhttp.readyState === 4) //We have gotten a response, but it wasn't good
      {
        window.clearTimeout(dotterTimer);
        document.getElementById("output").innerHTML = "<h1>There was an internal error with Jarvis. Please try again later.</h1>";
        document.getElementById("output").innerHTML += "<h3>Please check if this error has been reported under the 'Jarvis' announcement on Canvas, and if not, please report it with the error message below.</h3>";
        document.getElementById("output").innerHTML += "<span> The error message is: <code>" +
        xhttp.responseText +
          "</code></span>";
      }
    };

    xhttp.open("POST", endpoint, true);
    xhttp.send(formData);

    dotterTimer = setTimeout(dotter, 1000);

    document.getElementById('file').value = "";
    document.getElementById("uploadButton").disabled = true;
  }

  function dotter()
  {
   dotCount++;

   if (dotCount > 15)
   {
     document.getElementById("output").innerHTML += "<br />Jarvis is being slow, please be patient...";
     window.clearTimeout(dotterTimer);
   }
   else
   {
     document.getElementById("output").innerHTML += ".";
     dotterTimer = setTimeout(dotter, 1000);
   }
  }

  // file drag hover
  function FileDragHover(e)
  {
    e.stopPropagation();
    e.preventDefault();
    e.target.className = (e.type === "dragover" ? "hover" : "");
  }

  // file selection
  function FileSelectHandler(e)
  {
    // cancel event and hover styling
    FileDragHover(e);
    var files = e.target.files || e.dataTransfer.files;
    dragFile = files[0];
    uploadToJarvis('/run');
  }

  function initHandlers()
  {
    var filedrag = document.getElementById("filedrag");
    filedrag.addEventListener("dragover", FileDragHover, false);
    filedrag.addEventListener("dragleave", FileDragHover, false);
    filedrag.addEventListener("drop", FileSelectHandler, false);
    filedrag.style.display = "block";
  }
</script>
